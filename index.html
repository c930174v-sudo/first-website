<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ‹–æ›³é¡¯ç¤ºå™¨ (å¤šäººé›²ç«¯ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Firebase SDK (ç‰ˆæœ¬ 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- å…¨å±€è®Šæ•¸ ---
        let db;
        let auth;
        let storage;
        let userId;

        // --- Firebase åˆå§‹åŒ–å’Œèªè­‰ ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ç§»é™¤äº†å° __initial_auth_token çš„æœ¬åœ° const å®£å‘Šï¼Œé¿å… TDZ éŒ¯èª¤ã€‚

        async function initApp() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
                document.getElementById('message-box').textContent = "éŒ¯èª¤ï¼šç¼ºå°‘ Firebase è¨­å®šã€‚ç„¡æ³•å•Ÿç”¨é›²ç«¯å„²å­˜åŠŸèƒ½ã€‚";
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);

            // è¨­ç½®åŒ¿åç™»å…¥/èªè­‰ç›£è½å™¨
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("ç”¨æˆ¶å·²ç™»å…¥ï¼ŒUID:", userId);
                    document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
                    
                    // èªè­‰æˆåŠŸå¾Œï¼Œå•Ÿå‹•æ‰€æœ‰ Firestore ç›£è½å’Œäº‹ä»¶è™•ç†å™¨
                    setupEventListeners();
                    startImageListener();
                } else {
                    console.log("æ­£åœ¨å˜—è©¦åŒ¿åç™»å…¥...");
                    // å¦‚æœæ²’æœ‰ä½¿ç”¨è€…ï¼Œå‰‡åŸ·è¡ŒåŒ¿åç™»å…¥
                    // æ³¨æ„ï¼šé€™è£¡åªæœƒåœ¨æ²’æœ‰åˆå§‹ä»¤ç‰Œæˆ–ä»¤ç‰Œç™»å…¥å¤±æ•—å¾ŒåŸ·è¡Œ
                    signInAnonymously(auth).catch((error) => {
                        console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                        document.getElementById('message-box').textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}`;
                        document.getElementById('message-box').classList.remove('hidden');
                    });
                }
            });

            // æª¢æŸ¥æ˜¯å¦æœ‰åˆå§‹è‡ªè¨‚ä»¤ç‰Œ (__initial_auth_token æ˜¯ç”±ç’°å¢ƒæ³¨å…¥çš„å…¨åŸŸè®Šæ•¸) ä¸¦ä½¿ç”¨å®ƒç™»å…¥
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    // ä½¿ç”¨è‡ªè¨‚ä»¤ç‰Œç™»å…¥
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("è‡ªè¨‚ä»¤ç‰Œç™»å…¥å¤±æ•—:", error);
                    // ç™»å…¥å¤±æ•—å¾Œ onAuthStateChanged ç›£è½å™¨æœƒå˜—è©¦åŒ¿åç™»å…¥
                }
            } else {
                // å¦‚æœæ²’æœ‰è‡ªè¨‚ä»¤ç‰Œï¼ŒonAuthStateChanged æœƒåœ¨ç”¨æˆ¶ç‹€æ…‹ç‚ºç©ºæ™‚å˜—è©¦åŒ¿åç™»å…¥
                // æ­¤è™•ä¸éœ€è¦é¡å¤–æ“ä½œ
            }
        }
        
        // --- Firestore ç›£è½èˆ‡å³æ™‚é¡¯ç¤º ---
        function startImageListener() {
            // å…¬é–‹è³‡æ–™çš„è·¯å¾‘ï¼š/artifacts/{appId}/public/data/images
            const imageCollectionPath = `artifacts/${appId}/public/data/images`;
            const imageRef = collection(db, imageCollectionPath);
            
            // æŸ¥è©¢ï¼šæŒ‰ç…§æ™‚é–“æˆ³é™åºæ’åº (æœ€æ–°çš„åœ¨æœ€å‰é¢)
            // æ³¨æ„ï¼šFirestore æŸ¥è©¢ä¸­é¿å…ä½¿ç”¨ orderBy() ä»¥é˜²æ­¢é‹è¡Œæ™‚ç´¢å¼•éŒ¯èª¤
            // é€™è£¡ä¿ç•™ orderByï¼Œä½†åœ¨çœŸå¯¦ç’°å¢ƒä¸­å¯èƒ½éœ€è¦æ‰‹å‹•æ’åº
            const q = query(imageRef, orderBy("timestamp", "desc"));

            // è¨­ç½®å³æ™‚ç›£è½å™¨
            onSnapshot(q, (snapshot) => {
                const existingIds = new Set();
                const newImages = [];

                // æ”¶é›†å·²é¡¯ç¤ºçš„åœ–ç‰‡ ID
                document.querySelectorAll('#image-display > div').forEach(div => {
                    existingIds.add(div.dataset.docId);
                });

                // è™•ç†æ‰€æœ‰è®Šæ›´
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const docId = change.doc.id;
                    data.id = docId;

                    if (change.type === "added" && !existingIds.has(docId)) {
                        // æ–°å¢çš„åœ–ç‰‡ï¼šåªè™•ç†æœªé¡¯ç¤ºéçš„
                        newImages.push(data);
                    } else if (change.type === "removed") {
                        // ç§»é™¤çš„åœ–ç‰‡ï¼šå¾ DOM ä¸­åˆªé™¤
                        const elementToRemove = document.querySelector(`[data-doc-id="${docId}"]`);
                        if (elementToRemove) {
                            elementToRemove.remove();
                        }
                    }
                    // "modified" æš«æ™‚ä¸éœ€è¦è™•ç†
                });

                // å°‡æ–°çš„åœ–ç‰‡æ’å…¥åˆ°é¡¯ç¤ºå€çš„æœ€å‰é¢
                newImages.forEach(imgData => {
                    createImageElement(imgData.url, imgData.name, imgData.id, imgData.uploaderId);
                });
                
                if (document.getElementById('image-display').children.length === 0) {
                    document.getElementById('empty-message').classList.remove('hidden');
                } else {
                    document.getElementById('empty-message').classList.add('hidden');
                }

                console.log(`å³æ™‚æ›´æ–°ï¼šè¼‰å…¥äº† ${newImages.length} å¼µæ–°åœ–ç‰‡ã€‚`);
            });
        }
        
        // --- åœ–ç‰‡è™•ç†èˆ‡ä¸Šå‚³ ---

        // å‰µå»ºåœ–ç‰‡å…ƒç´ çš„ DOM çµæ§‹
        function createImageElement(url, name, docId, uploaderId) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé˜²æ­¢é‡è¤‡æ·»åŠ 
            if (document.querySelector(`[data-doc-id="${docId}"]`)) return;

            const imgContainer = document.createElement('div');
            // å°‡ Firestore Document ID å­˜ç‚ºè³‡æ–™å±¬æ€§ï¼Œä»¥ä¾¿è¿½è¹¤
            imgContainer.dataset.docId = docId; 
            imgContainer.className = 'bg-white p-4 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 overflow-hidden flex flex-col space-y-3';
            
            // åœ–ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.src = url; 
            img.alt = name;
            img.className = 'w-full h-48 object-cover rounded-lg border border-gray-100';

            // è³‡è¨Šå€å¡Š
            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-sm';
            
            const nameTag = document.createElement('p');
            nameTag.textContent = name;
            nameTag.title = name;
            nameTag.className = 'font-semibold text-gray-800 truncate';

            const uploaderTag = document.createElement('p');
            // åƒ…é¡¯ç¤º uploaderId çš„å‰ 8 å€‹å­—ç¬¦
            const displayUploaderId = uploaderId ? uploaderId.substring(0, 8) : 'Unknown';
            uploaderTag.textContent = `ä¸Šå‚³è€…: ${displayUploaderId}...`;
            uploaderTag.className = 'text-xs text-gray-500';

            infoDiv.appendChild(nameTag);
            infoDiv.appendChild(uploaderTag);

            imgContainer.appendChild(img);
            imgContainer.appendChild(infoDiv);

            // å°‡å®¹å™¨åŠ å…¥åˆ°é¡¯ç¤ºå€çš„æœ€å‰é¢ (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            document.getElementById('image-display').prepend(imgContainer);
        }

        // è™•ç†å–®å€‹æª”æ¡ˆçš„ä¸Šå‚³
        async function uploadFile(file) {
            // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
            if (!db || !storage) {
                showMessage("ç³»çµ±æœªæº–å‚™å°±ç·’ã€‚è«‹ç­‰å¾…èªè­‰å®Œæˆã€‚", true);
                return;
            }

            // 1. æª¢æŸ¥æª”æ¡ˆé¡å‹
            if (!file.type.startsWith('image/')) {
                showMessage(`æª”æ¡ˆ "${file.name}" ä¸æ˜¯æœ‰æ•ˆçš„åœ–ç‰‡æ ¼å¼ã€‚`, true);
                return;
            }

            showMessage(`æ­£åœ¨ä¸Šå‚³ "${file.name}"... è«‹ç¨å€™ã€‚`, false);
            
            try {
                // 2. æª”æ¡ˆä¸Šå‚³åˆ° Cloud Storage
                // æª”æ¡ˆè·¯å¾‘ï¼šimages/{appId}/{userId}/{æª”å}
                const storagePath = `images/${appId}/${userId}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, storagePath);
                
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // 3. æª”æ¡ˆè³‡è¨Šå„²å­˜åˆ° Firestore
                const imageCollectionPath = `artifacts/${appId}/public/data/images`;
                await addDoc(collection(db, imageCollectionPath), {
                    name: file.name,
                    url: downloadURL,
                    uploaderId: userId,
                    timestamp: serverTimestamp(),
                    storagePath: storagePath
                });

                showMessage(`"${file.name}" æˆåŠŸä¸Šå‚³ä¸¦åˆ†äº«ï¼`, false);

            } catch (error) {
                console.error("ä¸Šå‚³å¤±æ•—:", error);
                showMessage(`ä¸Šå‚³ "${file.name}" å¤±æ•—: ${error.message}`, true);
            }
        }

        // è™•ç†æ‹–æ›³æˆ–é¸æ“‡çš„å¤šå€‹æª”æ¡ˆ
        function handleFiles(files) {
            if (files.length === 0) return;

            let validFileCount = 0;
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    uploadFile(file);
                    validFileCount++;
                }
            }
            if (validFileCount === 0) {
                 showMessage("æ²’æœ‰é¸æ“‡ä»»ä½•åœ–ç‰‡æª”æ¡ˆã€‚", true);
            }
        }

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š (åœ¨èªè­‰æˆåŠŸå¾Œæ‰å‘¼å«) ---
        function setupEventListeners() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            // 1. æ‹–æ›³æª”æ¡ˆé€²å…¥/è¶Šé (Drag Enter/Over) äº‹ä»¶
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault(); 
                    e.stopPropagation();
                    dropZone.classList.add('drag-over');
                }, false);
            });

            // 2. æ‹–æ›³æª”æ¡ˆé›¢é–‹/æ”¾ä¸‹ (Drag Leave/Drop) äº‹ä»¶
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drag-over');
                }, false);
            });
            
            // 3. æ‹–æ›³æ”¾ä¸‹ (Drop) äº‹ä»¶ï¼šè™•ç†æª”æ¡ˆ
            dropZone.addEventListener('drop', (e) => {
                handleFiles(e.dataTransfer.files);
            }, false);
            
            // 4. é»æ“Šå€åŸŸé¸æ“‡æª”æ¡ˆ (Click to Select)
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            // 5. æª”æ¡ˆè¼¸å…¥æ¡†è®ŠåŒ– (File Input Change) äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                e.target.value = null; 
            });

            // é¡å¤–è™•ç†æ•´å€‹è¦–çª—çš„æ‹–æ›³äº‹ä»¶ï¼Œé˜²æ­¢æ‹–æ›³åˆ°éæŒ‡å®šå€åŸŸæ™‚æª”æ¡ˆåœ¨æ–°åˆ†é æ‰“é–‹
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
            }, false);
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
            }, false);

            // æ¸…é™¤æŒ‰éˆ•äº‹ä»¶
            document.getElementById('clear-display-btn').addEventListener('click', () => {
                document.getElementById('image-display').innerHTML = '';
                document.getElementById('empty-message').classList.remove('hidden');
                showMessage("å·²æ¸…é™¤æœ¬åœ°é¡¯ç¤ºï¼Œä½†é›²ç«¯ç…§ç‰‡ä»ç„¶å­˜åœ¨ã€‚", true);
            });
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;

        // --- è¨Šæ¯è¼”åŠ©å‡½æ•¸ (ä¿ç•™åœ¨å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿äº‹ä»¶è™•ç†å™¨ä½¿ç”¨) ---
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-3 rounded-lg border text-center ${isError ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300'}`;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }
        
        // ç¢ºä¿å‡½æ•¸åœ¨æ¨¡å¡Šå¤–éƒ¨å¯è¨ªå•
        window.showMessage = showMessage;
        window.hideMessage = hideMessage;

    </script>

    <style>
        /* è¨­ç½®å…¨å±€å­—é«”ç‚º Inter */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* è®“æ‹–æ›³å€çš„è™›ç·šæ¨£å¼æ›´æ¸…æ™° */
        #drop-zone {
            transition: all 0.3s ease;
        }
        .drag-over {
            border-color: #3b82f6 !important; /* æ‹–æ›³æ™‚é‚Šæ¡†è®Šè—è‰² */
            background-color: #eff6ff !important; /* æ‹–æ›³æ™‚èƒŒæ™¯è®Šæ·ºè—è‰² */
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">â˜ï¸ é›²ç«¯å”ä½œç…§ç‰‡ç‰†</h1>
            <p class="text-gray-500 text-lg">æ‹–æ›³åœ–ç‰‡åˆ°ä¸‹æ–¹å€åŸŸï¼Œå³åˆ»åˆ†äº«çµ¦æ‰€æœ‰ä½¿ç”¨æ­¤ç¶²ç«™çš„äººï¼</p>
            <!-- ç”¨æˆ¶ ID é¡¯ç¤ºå€ -->
            <p id="user-id-display" class="text-xs text-gray-400 mt-2"></p>
        </header>

        <!-- æ‹–æ›³å€ (Drop Zone) -->
        <div id="drop-zone" 
             class="w-full h-48 flex flex-col items-center justify-center p-6 border-4 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-blue-400 bg-white shadow-xl mb-6">
            <svg class="w-12 h-12 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            <p class="text-xl font-semibold text-gray-500">æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆä¸Šå‚³</p>
            <p class="text-sm text-gray-400">ï¼ˆåœ–ç‰‡å°‡æ°¸ä¹…å„²å­˜åœ¨é›²ç«¯ä¸¦å³æ™‚åŒæ­¥ï¼‰</p>
            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡†ï¼Œç”¨æ–¼é»æ“Šæ™‚é¸æ“‡æª”æ¡ˆ -->
            <input type="file" id="file-input" accept="image/*" multiple class="hidden">
        </div>

        <!-- éŒ¯èª¤æˆ–è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="message-box" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden text-center">
            <!-- éŒ¯èª¤è¨Šæ¯æˆ–æˆåŠŸè¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- åœ–ç‰‡é¡¯ç¤ºå€æ¨™é¡Œèˆ‡æ“ä½œ -->
        <div class="flex justify-between items-center mb-4 mt-10">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ–¼ï¸ å…±äº«åœ–ç‰‡ç‰†</h2>
            <button id="clear-display-btn" class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                æ¸…é™¤æœ¬åœ°é¡¯ç¤º
            </button>
        </div>
        
        <!-- åœ–ç‰‡é¡¯ç¤ºå€ (Image Display Area) -->
        <div id="image-display" 
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- è¼‰å…¥çš„é›²ç«¯åœ–ç‰‡å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- é¡¯ç¤ºåœ–ç‰‡ç‚ºç©ºæ™‚çš„è¨Šæ¯ -->
        <div id="empty-message" class="text-center p-10 mt-10 text-gray-500 bg-white rounded-xl shadow-inner border border-gray-200 hidden">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <p class="text-lg font-medium">é‚„æ²’æœ‰äººä¸Šå‚³åœ–ç‰‡ï¼å¿«æˆç‚ºç¬¬ä¸€å€‹åˆ†äº«çš„äººå§ã€‚</p>
        </div>

    </div>
</body>
</html>
